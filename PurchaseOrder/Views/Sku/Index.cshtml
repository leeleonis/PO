@model SKU
@section styles{
    <link href="~/Content/themes/default/easyui.css" rel="stylesheet" />
    <link href="~/Content/themes/icon.css" rel="stylesheet" />
    <style>
        .datagrid-btable .filterColumn:first-child td div {
            padding: 0
        }
    </style>
}
<div id="content">
    <section id="widget-grid" class="">
        <div class="row">
            <div class="table-parent tool-content col-xs-12">
                <div class="action-button col-xs-2 col-xs-offset-10">
                    <a class="btn btn-default" href="@Url.Action("Create")">新增</a>
                </div>
            </div>
        </div>

        <div class="row">
            <article class="col-xs-12">
                <table id="DataGrid"></table>
            </article>
        </div>
    </section>
</div>
@section pagespecific {
    <script src="~/scripts/jquery.easyui-1.4.3.min.js"></script>
    <script src="~/scripts/datagrid-detailview.js"></script>
    <script src="~/scripts/jquery.number.min.js"></script>
    <script type="text/javascript">
        var pager, pageSize = 100, selectOption;
        var $table = $("#DataGrid"), datagrid;

        $(function () {
            var data = { optionType: ['SkuCondition', 'SkuType', 'Replenishable', 'SkuStatus'] };

            website.AjaxUrl("@Url.Action("GetSelectOption", "Ajax")", 'post', data).done(function (response) {
                if (response.status) {
                    selectOption = response.data;

                    dataInit();
                } else {
                    alert(response.message);
                }
            });
        });

        function dataInit() {
            datagrid = new Datagrid("品號 列表", "SkuID", "@Url.Action("GetData")");

            datagrid.dataInit.frozenColumns = [[
                { field: "ck", checkbox: true },
                { field: "SkuID", title: "@Html.DisplayNameFor(model => model.SkuID)", width: 120, align: "center", sortable: false, }
            ]];

            datagrid.dataInit.columns = [[
                { field: "ParentSku", title: "@Html.DisplayNameFor(model => model.ParentSku)", width: 120, align: "center", sortable: false },
                {
                    field: "Name", title: "@Html.DisplayNameFor(model => model.SkuLang.First().Name)", width: 500, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setInputText(row.SkuID, this.field, value) : value;
                    }
                }, {
                    field: "Condition", title: "@Html.DisplayNameFor(model => model.Condition)", width: 220, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setDropdown(row.SkuID, this.field, selectOption['SkuCondition'], value.toString()) : value;
                    }
                }, {
                    field: "Category", title: "@Html.DisplayNameFor(model => model.Category)", width: 200, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setDropdown(row.SkuID, this.field, selectOption['SkuType'], value.toString()) : value;
                    }
                }, {
                    field: "UPC", title: "@Html.DisplayNameFor(model => model.UPC)", width: 150, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setInputText(row.SkuID, this.field, value) : value;
                    }
                }, {
                    field: "EAN", title: "@Html.DisplayNameFor(model => model.EAN)", width: 150, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setInputText(row.SkuID, this.field, value) : value;
                    }
                }, {
                    field: "Replenishable", title: "@Html.DisplayNameFor(model => model.Replenishable)", width: 100, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setCheckBox(row.SkuID, this.field, value) : value;
                    }
                }, {
                    field: "Status", title: "@Html.DisplayNameFor(model => model.Status)", width: 100, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        return website.IsEmpty(row.IsFilter) ? datagrid.setDropdown(row.SkuID, this.field, selectOption['SkuStatus'], value) : value;
                    }
                }, {
                    field: "Save", title: "Save", width: 90, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        if (website.IsEmpty(row.IsFilter)) {
                            return "<button type='button' class='btn btn-default btn-sm' id='btn-save' onclick='SaveData(\"" + row.SkuID + "\")' disabled>SAVE</button>";
                        } else {
                            return value;
                        }
                    }
                }, {
                    field: "Action", title: "Action", width: 90, align: "center", sortable: false,
                    formatter: function (value, row, index) {
                        if (website.IsEmpty(row.IsFilter)) {
                            return "<a class='btn btn-default btn-sm' href='@Url.Action("Edit", "Sku")/" + row.SkuID + "'>EDIT</button>";
                        }
                    }
                }
            ]];

            $table.datagrid(datagrid.dataInit);

            pager = $table.datagrid("getPager");
            $(pager).pagination({
                pageSize: pageSize,
                showPageList: true,
                pageList: [100, 200, 300, 500],
                beforePageTest: "第",
                afterPageTest: "頁，共 {pages} 頁",
                displayMsg: "顯示 {from} 到 {to} 筆資料，共 {total} 筆資料"
            });
        }

        function getFilterData() {
            return {
                SkuID: $('.filterColumn .s-skuID').val(),
                ParentSku: $('.filterColumn .s-parentSku').val(),
                Name: $('.filterColumn .s-name').val(),
                Condition: $('.filterColumn .s-condition').val(),
                Category: $('.filterColumn .s-category').val(),
                UPC: $('.filterColumn .s-UPC').val(),
                EAN: $('.filterColumn .s-EAN').val(),
                Replenishable: $('.filterColumn .s-replenishable').val(),
                Status: $('.filterColumn .s-status').val()
            };
        }

        function setFilterColumn(filterValue) {
            return {
                IsFilter: true,
                SkuID: "<input type='text' class='form-control s-skuID' value='" + (!website.IsEmpty(filterValue['SkuID']) ? filterValue['SkuID'] : '') + "'>",
                ParentSku: "<input type='text' class='form-control s-parentSku' value='" + (!website.IsEmpty(filterValue['ParentSku']) ? filterValue['ParentSku'] : '') + "'>",
                Name: "<input type='text' class='form-control s-name' value='" + (!website.IsEmpty(filterValue['Name']) ? filterValue['Name'] : '') + "'>",
                Condition: "<select class='form-control s-condition'><option value=''>全部</option>" + datagrid.setSelectOption(selectOption['SkuCondition'], filterValue['Condition']) + "</select>",
                Category: "<select class='form-control s-category'><option value=''>全部</option>" + datagrid.setSelectOption(selectOption['SkuType'], filterValue['Category']) + "</select>",
                UPC: "<input type='text' class='form-control s-UPC' value='" + (!website.IsEmpty(filterValue['UPC']) ? filterValue['UPC'] : '') + "'>",
                EAN: "<input type='text' class='form-control s-EAN' value='" + (!website.IsEmpty(filterValue['EAN']) ? filterValue['EAN'] : '') + "'>",
                Replenishable: "<select class='form-control s-replenishable'><option value=''>全部</option>" + datagrid.setSelectOption(selectOption['Replenishable'], filterValue['Replenishable']) + "</select>",
                Status: "<select class='form-control s-status'><option value=''>全部</option>" + datagrid.setSelectOption(selectOption['SkuStatus'], filterValue['Status']) + "</select>",
                Save: "<button type='button' class='btn btn-default btn-sm' onclick='SaveData()'>SAVE ALL</button>"
            };
        }

        function onDataChange(ID) {
            var index = $table.datagrid("getRowIndex", ID) - 1;

            $table.datagrid('checkRow', index + 1);
            $("button#btn-save:eq(" + index + ")").removeAttr("disabled");
        }

        function SaveData(ID) {
            var dataList = [];

            if (website.IsEmpty(ID)) {
                var rows = $table.datagrid('getChecked');
                console.log(rows);
                for (var i in rows) {
                    index = $table.datagrid('getRowIndex', rows[i].SkuID) - 1;
                    if (!$("button#btn-save:eq(" + index + ")").is("[disabled]")) {
                        dataList.push(setData(rows[i], index));
                        $("button#btn-save:eq(" + index + ")").attr("disabled", "disabled");
                    }
                }
            } else {
                var index = $table.datagrid("getRowIndex", ID) - 1;
                row = $table.datagrid("getRows")[index + 1];
                dataList.push(setData(row, index));
                $("button#btn-save:eq(" + index + ")").attr("disabled", "disabled");
            }

            if (dataList.length > 0) {
                dataList.forEach(function (data) {
                    $.ajax({
                        url: "@Url.Action("Update")",
                        type: "post",
                        data: data,
                        dataType: "json"
                    });
                });

                alert('Success!');
            };

            $table.datagrid('uncheckAll');
        }

        function setData(row, index) {
            return {
                SkuID: row.SkuID,
                ParentSku: row.ParentSku,
                Name: $("input#Name:eq(" + index + ")").val(),
                Condition: $("select#Condition:eq(" + index + ")").val(),
                Category: $("select#Category:eq(" + index + ")").val(),
                Brand: row.Brand,
                UPC: $("input#UPC:eq(" + index + ")").val(),
                EAN: $("input#EAN:eq(" + index + ")").val(),
                Replenishable: $("input#Replenishable:eq(" + index + ")").prop('checked'),
                Status: $("select#Status:eq(" + index + ")").val()
            }
        }
    </script>
}